---
layout: post
title: JIT
category: base
keywords: 即时编译
---

### 1、什么是JIT？

JIT 编译（just-in-time compilation），即时编译，当某段代码第一次执行时进行编译。java程序最初是通过解释器（Interpreter）解释执行的，当虚拟机发现某个方法或代码块执行特别频繁，则认定其为热点代码，为提高效率虚拟机将使用JIT编译器其编译为与本地平台相关的机器码并进行各种优化。

JIT不是虚拟机规范中必须的即时编译器编译性能的好坏、代码优化程度的高低却是衡量一款商用虚拟机优秀与否的最关键的指标之一，它也是虚拟机中最核心且最能体现虚拟机技术水平的部分。

### 2、解释器与编译器并行

为什么并行？

编译时间开销、编译空间开销、编译时机对优化的影响(太早太晚都不行)

编译器编译后的代码空间开销很大（10倍以上），如所有代码编译将使代码空间占用很大导致代码爆炸。

解释器优势：当程序需要迅速启动和执行，解释器省去编译时间立即执行，后续编译器逐渐发挥作用得到更高效率。当内存限制较大时，解释执行可以节约内存。

只执行一次的代码同时满足：指调用一次如类的构造器、没有循环

### 3、JIT是如何执行的？

![](https://i.loli.net/2020/11/01/C91RNA7WMYQ3jua.jpg)

解释器：输入的代码 -> [解释器 解释执行] -> 执行结果

编译器：输入的代码 -> [编译器 编译] -> 编译后的代码 -> [ 执行 ] -> 执行结果

当编译器编译后的效果不理想可退回到解释器执行。

### 4、hostspot的JIT

Client Complier(C1)：获取更高的编译速度，主要关注点在于局部优化，而放弃许多耗时较长的全局优化手段。

Server Complier(C2)：获取更好的编译质量，面向服务器端的，并为服务端的性能配置特别调整过的编译器，是一个充分优化过的高级编译器。

选择方式：

1.hotspot根据自身版本和硬件性能自动选择

2.指定-client或-server

### 5、热点代码

1、被多次调用的方法。

2、被多次执行的循环体。

编译器以整个方法作为编译对象，编译发生在方法执行的过程中，称之为栈上替换（On Stack Replacement，简称为 OSR 编译），方法栈帧还在栈上方法被替换。

热点探测方式：

(1)基于采样的热点探测：周期性检测线程的栈顶

(2) 基于计数器的热点探测：方法计数器（Hotspot）

Hotspot的检测方式

方法调用计数器：方法调用未被JIT编译过增加计数器，判断方法调用计数器与回边计数器值之和是否超过方法调用计数器的阈值。编译完成后改写方法入口。

![](https://i.loli.net/2020/11/01/2q1I8V4BWJ6pgQZ.png)

回边计数器：统计一个方法中循环体代码执行的次数，在字节码中遇到控制流向后跳转的指令称为 “回边”。

![](https://i.loli.net/2020/11/01/3q1OEvYwZxSkdpG.png)

### 4、其他概念

动态编译（dynamic compilation）指的是 “在运行时进行编译”；与之相对的是事前编译（ahead-of-time compilation，简称 AOT），也叫静态编译（static compilation）。

自适应动态编译（adaptive dynamic compilation）也是一种动态编译，但它通常执行的时机比 JIT 编译迟，先让程序 “以某种式” 先运行起来，收集一些信息之后再做动态编译。这样的编译可以更加优化。

